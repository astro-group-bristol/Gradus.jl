<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Implementing new metrics · Gradus.jl Documentation</title><meta name="title" content="Implementing new metrics · Gradus.jl Documentation"/><meta property="og:title" content="Implementing new metrics · Gradus.jl Documentation"/><meta property="twitter:title" content="Implementing new metrics · Gradus.jl Documentation"/><meta name="description" content="Documentation for Gradus.jl Documentation."/><meta property="og:description" content="Documentation for Gradus.jl Documentation."/><meta property="twitter:description" content="Documentation for Gradus.jl Documentation."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="Gradus.jl Documentation logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">Gradus.jl Documentation</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../getting-started/">Getting started</a></li><li><a class="tocitem" href="../examples/">Examples</a></li><li><span class="tocitem">Reference &amp; walkthroughs</span><ul><li><a class="tocitem" href="../metrics/">Catalogue of metrics</a></li><li><a class="tocitem" href="../accretion-geometry/">Accretion geometry</a></li><li><a class="tocitem" href="../problems-and-solvers/">Problems and solvers</a></li><li><a class="tocitem" href="../point-functions/">Point functions</a></li><li><a class="tocitem" href="../emissivity/">Disc emissivity</a></li><li><a class="tocitem" href="../lineprofiles/">Line profiles</a></li><li><a class="tocitem" href="../adaptive-tracing/">Adaptive tracing</a></li></ul></li><li><span class="tocitem">Geodesics and integration</span><ul><li class="is-active"><a class="tocitem" href>Implementing new metrics</a><ul class="internal"><li><a class="tocitem" href="#Example:-Schwarzschild"><span>Example: Schwarzschild</span></a></li><li><a class="tocitem" href="#Metric-parameter-types"><span>Metric parameter types</span></a></li></ul></li><li><a class="tocitem" href="../geodesic-integration/">Geodesic integration</a></li><li><a class="tocitem" href="../parallelism/">Parallelism and ensembles</a></li><li><a class="tocitem" href="../special-radii/">Special radii</a></li></ul></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="../api-documentation/Gradus/">Gradus</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Geodesics and integration</a></li><li class="is-active"><a href>Implementing new metrics</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Implementing new metrics</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/astro-group-bristol/Gradus.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/astro-group-bristol/Gradus.jl/blob/main/docs/src/custom-metrics.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Implementing-a-new-metric"><a class="docs-heading-anchor" href="#Implementing-a-new-metric">Implementing a new metric</a><a id="Implementing-a-new-metric-1"></a><a class="docs-heading-anchor-permalink" href="#Implementing-a-new-metric" title="Permalink"></a></h1><p>Gradus.jl is able to integrate any 3+1 dimensional metric. A new metric may be defined by implementing one of the abstract types with a concrete type, and defining a number of methods. Depending on what you want to be able to do with a metric, different functions need to be implemented. </p><p>Gradus also provides a few derivative abstract types to implement to ensure the most efficient code is executed for a given metric (see <a href="#Metric-parameter-types">Metric parameter types</a> below).</p><h2 id="Example:-Schwarzschild"><a class="docs-heading-anchor" href="#Example:-Schwarzschild">Example: Schwarzschild</a><a id="Example:-Schwarzschild-1"></a><a class="docs-heading-anchor-permalink" href="#Example:-Schwarzschild" title="Permalink"></a></h2><p>As a minimal example, here is how the Schwarzschild metric may be implemented. First, we must define what the <em>metric parameters</em> for this metric are. These are effectively constants of the spacetime, representing physical quantities that appear in the metric expression. For the Schwarzschild metric, this is only the black hole mass <span>$M$</span>, but e.g. the Kerr metric also has the black hole spin <span>$a$</span>.</p><p>We can choose the integration strategy by sub-typing an abstract type representing different classes of spacetimes. For the Schwarzschild metric, we will use the static, axis-symmetric class, with the automatic differentiation (AD) backend. With AD, we only need to specify the non-zero components of the metric as Julia functions, and the rest is done for us.</p><p>For ease, we choose the <a href="https://en.wikipedia.org/wiki/Eddington%E2%80%93Finkelstein_coordinates">Eddington-Finkelstein coordinates</a> of the Schwarzschild solution, which may be written</p><p class="math-container">\[\text{d}s^2 =
    - \left( 1 - \frac{2 M}{r} \right) \text{d}t^2
    + \left( 1 - \frac{2 M}{r} \right)^{-1} \text{d}r^2
    + r^2 \text{d}\theta^2
    + r^2 \sin^2(\theta) \text{d}\phi^2.\]</p><p>Here is a possible implementation for Gradus.jl:</p><pre><code class="language-julia hljs">using Gradus

@with_kw struct EddingtonFinkelsteinAD{T} &lt;: AbstractStaticAxisSymmetric{T}
    M = 1.0
end

function Gradus.metric_components(m::EddingtonFinkelsteinAD{T}, rθ) where {T}
    (r, θ) = rθ
    M = m.M

    tt = -(1 - (2M / r))
    rr = -inv(tt)
    θθ = r^2
    ϕϕ = r^2 * sin(θ)^2

    (tt, rr, θθ, ϕϕ, T(0.0))
end

Gradus.inner_radius(m::EddingtonFinkelsteinAD) = 2 * m.M</code></pre><p>A few notes:</p><ul><li>We use <code>@with_kw</code> from <a href="https://github.com/mauro3/Parameters.jl">Parameters.jl</a> to define various utility constructors for us.</li><li><a href="#Gradus.metric_components"><code>metric_components</code></a> must return five elements for <a href="#Gradus.AbstractStaticAxisSymmetric"><code>AbstractStaticAxisSymmetric</code></a>, where the last element is the off-axis <span>$g_{t \phi}$</span> matrix element, which in this case is always 0.</li><li>The <a href="@ref"><code>inner_radius</code></a> function defines the inner-radius of integration chart. This defines where the integration should terminate to avoid running indefinitely, and is, in this case, set to the event-horizon of our metric.</li></ul><p>That&#39;s all we need! This metric is now ready to be traced in the usual way.</p><div class="admonition is-info" id="Note-28e6c3074b85cc0d"><header class="admonition-header">Note<a class="admonition-anchor" href="#Note-28e6c3074b85cc0d" title="Permalink"></a></header><div class="admonition-body"><p>For more examples of how to implement different metrics, click on the &quot;source&quot; button of a metric in <a href="@ref">Implemented Metrics</a>. Alternatively, view the source code directly <a href="https://github.com/astro-group-bristol/Gradus.jl/tree/main/src/metrics">here</a>.</p></div></div><h2 id="Metric-parameter-types"><a class="docs-heading-anchor" href="#Metric-parameter-types">Metric parameter types</a><a id="Metric-parameter-types-1"></a><a class="docs-heading-anchor-permalink" href="#Metric-parameter-types" title="Permalink"></a></h2><p>The following types may be implemented to add new metrics. Each type has different requirements for its interface.</p><h3 id="First-Order"><a class="docs-heading-anchor" href="#First-Order">First-Order</a><a id="First-Order-1"></a><a class="docs-heading-anchor-permalink" href="#First-Order" title="Permalink"></a></h3><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Gradus.AbstractFirstOrderMetric" href="#Gradus.AbstractFirstOrderMetric"><code>Gradus.AbstractFirstOrderMetric</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">AbstractFirstOrderMetric{T} &lt;: AbstractMetric{T}</code></pre><p>Abstract type for metrics using the 1st-order integration method. The 1st-order methods reuse the velocity vector as a parameter vector, where only element <code>vel[2]</code> and <code>vel[3]</code> are used, and are local observer ratios <span>$\sin \Theta$</span> and <span>$\sin \Phi$</span> respectively.</p><p>Require implementation of</p><ul><li><a href="@ref"><code>inner_radius</code></a></li><li><a href="../getting-started/#Gradus.constrain"><code>constrain</code></a></li><li><a href="#Gradus.four_velocity"><code>four_velocity</code></a></li><li><a href="#Gradus.calc_lq"><code>calc_lq</code></a></li><li><a href="#Gradus.Vr"><code>Vr</code></a></li><li><a href="#Gradus.Vθ"><code>Vθ</code></a></li><li><a href="@ref"><code>impact_parameters_to_three_velocity</code></a></li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/astro-group-bristol/Gradus.jl/blob/2d00d2046fda84a9fd91597eae08531a704d70df/src/tracing/method-implementations/first-order.jl#L1-L16">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Gradus.four_velocity" href="#Gradus.four_velocity"><code>Gradus.four_velocity</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">four_velocity(x, m::AbstractFirstOrderMetric, p)</code></pre><p>Calculate the four-velocity at a point <code>u</code>, given a set of metric parameters and the constants of motion in <code>p</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/astro-group-bristol/Gradus.jl/blob/2d00d2046fda84a9fd91597eae08531a704d70df/src/tracing/method-implementations/first-order.jl#L79-L84">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Gradus.calc_lq" href="#Gradus.calc_lq"><code>Gradus.calc_lq</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">calc_lq(m::AbstractFirstOrderMetric, pos, param))</code></pre><p>Calculate constants of motion <span>$L$</span> and <span>$Q$</span>, given a set of metric parameters, the geodesic position, and the <code>param</code> vector.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/astro-group-bristol/Gradus.jl/blob/2d00d2046fda84a9fd91597eae08531a704d70df/src/tracing/method-implementations/first-order.jl#L155-L160">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Gradus.Vr" href="#Gradus.Vr"><code>Gradus.Vr</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">Vr(m::AbstractFirstOrderMetric, u, p)</code></pre><p>Effective potential in the radial direction. Used only to track sign changes.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/astro-group-bristol/Gradus.jl/blob/2d00d2046fda84a9fd91597eae08531a704d70df/src/tracing/method-implementations/first-order.jl#L142-L146">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Gradus.Vθ" href="#Gradus.Vθ"><code>Gradus.Vθ</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">Vθ(m::AbstractFirstOrderMetric, u, p)</code></pre><p>Effective potential in the angular direction. Used only to track sign changes.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/astro-group-bristol/Gradus.jl/blob/2d00d2046fda84a9fd91597eae08531a704d70df/src/tracing/method-implementations/first-order.jl#L148-L152">source</a></section></article><h3 id="Second-Order"><a class="docs-heading-anchor" href="#Second-Order">Second-Order</a><a id="Second-Order-1"></a><a class="docs-heading-anchor-permalink" href="#Second-Order" title="Permalink"></a></h3><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Gradus.metric_components" href="#Gradus.metric_components"><code>Gradus.metric_components</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">metric_components(m::AbstractMetric{T}, x)</code></pre><p>Return a tuple with each non-zero metric component for the metric described by <code>m</code> at position <code>x</code>. Note that the position need not be a four-vector, and for specific implementations may only be a subset of the total manifold coordinates. See specific implementations for subtypes of <a href="../metrics/#Gradus.AbstractMetric"><code>AbstractMetric</code></a> for details.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/astro-group-bristol/Gradus.jl/blob/2d00d2046fda84a9fd91597eae08531a704d70df/src/Gradus.jl#L89-L96">source</a></section><section><div><pre><code class="language-julia hljs">metric_components(m::AbstractStaticAxisSymmetric, rθ</code></pre><p>Interface for <a href="#Gradus.AbstractStaticAxisSymmetric"><code>AbstractStaticAxisSymmetric</code></a>. Should return a vector or tuple with the elements</p><p class="math-container">\[\left(
    g_{tt}, g_{rr}, g_{\theta \theta}, g_{\phi \phi}, g_{t\phi}
\right).\]</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/astro-group-bristol/Gradus.jl/blob/2d00d2046fda84a9fd91597eae08531a704d70df/src/tracing/method-implementations/auto-diff.jl#L22-L32">source</a></section></article><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="Gradus.AbstractStaticAxisSymmetric" href="#Gradus.AbstractStaticAxisSymmetric"><code>Gradus.AbstractStaticAxisSymmetric</code></a> — <span class="docstring-category">Type</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">AbstractStaticAxisSymmetric{T}</code></pre><p>Specialisation for static, axis-symmetric metrics. Here, the metric is of the form</p><p class="math-container">\[    g_{\mu\nu} =
    \left( \begin{matrix}
        g_{tt}     &amp; 0      &amp; 0                  &amp; g_{t\phi}     \\
        0          &amp; g_{rr} &amp; 0                  &amp; 0              \\
        0          &amp; 0      &amp; g_{\theta\theta} &amp; 0              \\
        g_{t\phi} &amp; 0      &amp; 0                  &amp; g_{\phi\phi}
    \end{matrix} \right),\]</p><p>where the only non-zero off axis elements are <span>$g_{t\phi}$</span>.</p><p>Required implementations:</p><ul><li><a href="@ref"><code>inner_radius</code></a></li><li><a href="#Gradus.metric_components"><code>metric_components</code></a></li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/astro-group-bristol/Gradus.jl/blob/2d00d2046fda84a9fd91597eae08531a704d70df/src/tracing/method-implementations/auto-diff.jl#L1-L19">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../adaptive-tracing/">« Adaptive tracing</a><a class="docs-footer-nextpage" href="../geodesic-integration/">Geodesic integration »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Tuesday 14 October 2025 15:05">Tuesday 14 October 2025</span>. Using Julia version 1.11.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
