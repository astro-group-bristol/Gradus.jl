<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Implementing new metrics · Gradus.jl Documentation</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="Gradus.jl Documentation logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Gradus.jl Documentation</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Overview</span><ul><li><a class="tocitem" href="../../overview/examples/">Examples</a></li><li><a class="tocitem" href="../../overview/point-functions/">Point functions</a></li><li><a class="tocitem" href="../../overview/metrics/">Available metrics</a></li><li><a class="tocitem" href="../../overview/accretion-geometry/">Accretion geometry</a></li></ul></li><li><span class="tocitem">Internals</span><ul><li><a class="tocitem" href="../../overview/geodesic-integration/">Geodesic integration</a></li><li class="is-active"><a class="tocitem" href>Implementing new metrics</a><ul class="internal"><li><a class="tocitem" href="#Example:-Schwarzschild"><span>Example: Schwarzschild</span></a></li><li><a class="tocitem" href="#Metric-parameter-types"><span>Metric parameter types</span></a></li></ul></li><li><a class="tocitem" href="../special-radii/">Special radii</a></li></ul></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="../../api-documentation/Gradus/">Gradus</a></li><li><a class="tocitem" href="../../api-documentation/GradusBase/">GradusBase</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Internals</a></li><li class="is-active"><a href>Implementing new metrics</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Implementing new metrics</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/astro-group-bristol/Gradus.jl/blob/main/docs/src/internals/custom-metrics.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Implementing-a-new-metric"><a class="docs-heading-anchor" href="#Implementing-a-new-metric">Implementing a new metric</a><a id="Implementing-a-new-metric-1"></a><a class="docs-heading-anchor-permalink" href="#Implementing-a-new-metric" title="Permalink"></a></h1><p>Gradus.jl is able to integrate any 3+1 dimensional metric. A new metric may be defined by implementing one of the abstract types with a concrete type, and defining a number of methods. Depending on what you want to be able to do with a metric, different functions need to be implemented. </p><p>Gradus also provides a few derivative abstract types to implement to ensure the most efficient code is executed for a given metric (see <a href="#Metric-parameter-types">Metric parameter types</a> below).</p><h2 id="Example:-Schwarzschild"><a class="docs-heading-anchor" href="#Example:-Schwarzschild">Example: Schwarzschild</a><a id="Example:-Schwarzschild-1"></a><a class="docs-heading-anchor-permalink" href="#Example:-Schwarzschild" title="Permalink"></a></h2><p>As a minimal example, here is how the Schwarzschild metric may be implemented. First, we must define what the <em>metric parameters</em> for this metric are. These are effectively constants of the spacetime, representing physical quantities that appear in the metric expression. For the Schwarzschild metric, this is only the black hole mass <span>$M$</span>, but e.g. the Kerr metric also has the black hole spin <span>$a$</span>.</p><p>We can choose the integration strategy by sub-typing an abstract type representing different classes of spacetimes. For the Schwarzschild metric, we will use the static, axis-symmetric class, with the automatic differentiation (AD) backend. With AD, we only need to specify the non-zero components of the metric as Julia functions, and the rest is done for us.</p><p>For ease, we choose the <a href="https://en.wikipedia.org/wiki/Eddington%E2%80%93Finkelstein_coordinates">Eddington-Finkelstein coordinates</a> of the Schwarzschild solution, which may be written</p><p class="math-container">\[\text{d}s^2 =
    - \left( 1 - \frac{2 M}{r} \right) \text{d}t^2
    + \left( 1 - \frac{2 M}{r} \right)^{-1} \text{d}r^2
    + r^2 \text{d}\theta^2
    + r^2 \sin^2(\theta) \text{d}\phi^2.\]</p><p>Here is a possible implementation for Gradus.jl:</p><pre><code class="language-julia hljs">using Gradus

@with_kw struct EddingtonFinkelsteinAD{T} &lt;: AbstractAutoDiffStaticAxisSymmetricParams{T}
    M = 1.0
end

function GradusBase.metric_components(m::EddingtonFinkelsteinAD{T}, rθ) where {T}
    (r, θ) = rθ
    M = m.M

    tt = -(1 - (2M / r))
    rr = -inv(tt)
    θθ = r^2
    ϕϕ = r^2 * sin(θ)^2

    (tt, rr, θθ, ϕϕ, T(0.0))
end

GradusBase.inner_radius(m::BoyerLindquistAD{T}) where {T} = 2 * m.M</code></pre><p>A few notes:</p><ul><li>We use <code>@with_kw</code> from <a href="https://github.com/mauro3/Parameters.jl">Parameters.jl</a> to define various utility constructors for us.</li><li><a href="#Gradus.GradusBase.metric_components"><code>GradusBase.metric_components</code></a> must return five elements for <a href="#Gradus.AbstractAutoDiffStaticAxisSymmetricParams"><code>AbstractAutoDiffStaticAxisSymmetricParams</code></a>, where the last element is the off-axis <span>$g_{t \phi}$</span> matrix element, which in this case is always 0.</li><li>The <a href="../../api-documentation/GradusBase/#Gradus.GradusBase.inner_radius-Union{Tuple{AbstractMetricParams{T}}, Tuple{T}} where T"><code>GradusBase.inner_radius</code></a> function defines the inner-radius of integration chart. This defines where the integration should terminate to avoid running indefinitely, and is, in this case, set to the event-horizon of our metric.</li></ul><p>That&#39;s all we need! This metric is now ready to be traced in the usual way.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>For more examples of how to implement different metrics, click on the &quot;source&quot; button of a metric in <a href="internals/@ref">Implemented Metrics</a>. Alternatively, view the source code directly <a href="https://github.com/astro-group-bristol/Gradus.jl/tree/main/src/metrics">here</a>.</p></div></div><h2 id="Metric-parameter-types"><a class="docs-heading-anchor" href="#Metric-parameter-types">Metric parameter types</a><a id="Metric-parameter-types-1"></a><a class="docs-heading-anchor-permalink" href="#Metric-parameter-types" title="Permalink"></a></h2><p>The following types may be implemented to add new metrics. Each type has different requirements for its interface.</p><h3 id="First-Order"><a class="docs-heading-anchor" href="#First-Order">First-Order</a><a id="First-Order-1"></a><a class="docs-heading-anchor-permalink" href="#First-Order" title="Permalink"></a></h3><article class="docstring"><header><a class="docstring-binding" id="Gradus.AbstractFirstOrderMetricParams" href="#Gradus.AbstractFirstOrderMetricParams"><code>Gradus.AbstractFirstOrderMetricParams</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">AbstractFirstOrderMetricParams{T} &lt;: AbstractMetricParams{T}</code></pre><p>Abstract type for metrics using the 1st-order integration method. The 1st-order methods reuse the velocity vector as a parameter vector, where only element <code>vel[2]</code> and <code>vel[3]</code> are used, and are local observer ratios <span>$\sin \Theta$</span> and <span>$\sin \Phi$</span> respectively.</p><p>Require implementation of</p><ul><li><a href="../../api-documentation/GradusBase/#Gradus.GradusBase.inner_radius-Union{Tuple{AbstractMetricParams{T}}, Tuple{T}} where T"><code>inner_radius</code></a></li><li><a href="../../api-documentation/GradusBase/#Gradus.GradusBase.constrain-Union{Tuple{T}, Tuple{AbstractMetricParams{T}, Any, Any}} where T"><code>constrain</code></a></li><li><a href="#Gradus.four_velocity"><code>four_velocity</code></a></li><li><a href="#Gradus.calc_lq"><code>calc_lq</code></a></li><li><a href="#Gradus.Vr"><code>Vr</code></a></li><li><a href="#Gradus.Vθ"><code>Vθ</code></a></li><li><a href="internals/@ref"><code>impact_parameters_to_vel</code></a></li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/astro-group-bristol/Gradus.jl/blob/986ca5b98f4e4d33258968a79ebdcbc130579561/src/tracing/method-implementations/first-order.jl#L1-L16">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="Gradus.four_velocity" href="#Gradus.four_velocity"><code>Gradus.four_velocity</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">four_velocity(
    u,
    m::AbstractFirstOrderMetricParams,
    p
) -&gt; NTuple{4, Any}
</code></pre><p>Calculate the four-velocity at a point <code>u</code>, given a set of metric parameters and the constants of motion in <code>p</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/astro-group-bristol/Gradus.jl/blob/986ca5b98f4e4d33258968a79ebdcbc130579561/src/tracing/method-implementations/first-order.jl#L66-L71">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="Gradus.calc_lq" href="#Gradus.calc_lq"><code>Gradus.calc_lq</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">calc_lq(
    m::AbstractFirstOrderMetricParams{T},
    pos,
    param
) -&gt; Tuple{Any, Any}
</code></pre><p>Calculate constants of motion <span>$L$</span> and <span>$Q$</span>, given a set of metric parameters, the geodesic position, and the <code>param</code> vector.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/astro-group-bristol/Gradus.jl/blob/986ca5b98f4e4d33258968a79ebdcbc130579561/src/tracing/method-implementations/first-order.jl#L120-L125">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="Gradus.Vr" href="#Gradus.Vr"><code>Gradus.Vr</code></a> — <span class="docstring-category">Function</span></header><section><div><p>Effective potential in the radial direction. Used only to track sign changes.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/astro-group-bristol/Gradus.jl/blob/986ca5b98f4e4d33258968a79ebdcbc130579561/src/tracing/method-implementations/first-order.jl#L105-L109">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="Gradus.Vθ" href="#Gradus.Vθ"><code>Gradus.Vθ</code></a> — <span class="docstring-category">Function</span></header><section><div><p>Effective potential in the angular direction. Used only to track sign changes.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/astro-group-bristol/Gradus.jl/blob/986ca5b98f4e4d33258968a79ebdcbc130579561/src/tracing/method-implementations/first-order.jl#L112-L116">source</a></section></article><h3 id="Second-Order"><a class="docs-heading-anchor" href="#Second-Order">Second-Order</a><a id="Second-Order-1"></a><a class="docs-heading-anchor-permalink" href="#Second-Order" title="Permalink"></a></h3><article class="docstring"><header><a class="docstring-binding" id="Gradus.AbstractAutoDiffMetricParams" href="#Gradus.AbstractAutoDiffMetricParams"><code>Gradus.AbstractAutoDiffMetricParams</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">AbstractAutoDiffMetricParams{T} &lt;: AbstractMetricParams{T}</code></pre><p>Abstract type for metrics using the 2nd-order integration method, with the automatic differentiation backend.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/astro-group-bristol/Gradus.jl/blob/986ca5b98f4e4d33258968a79ebdcbc130579561/src/tracing/method-implementations/auto-diff.jl#L3-L8">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="Gradus.GradusBase.metric_components" href="#Gradus.GradusBase.metric_components"><code>Gradus.GradusBase.metric_components</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">metric_components(m::AbstractMetricParams{T}, x)</code></pre><p>Return a tuple with each non-zero metric component for the metric described by <code>m</code> at position <code>x</code>. Note that the position need not be a four-vector, and for specific implementations may only be a subset of the total manifold coordinates. See specific implementations for subtypes of <a href="#Gradus.GradusBase.AbstractMetricParams"><code>AbstractMetricParams</code></a> for details.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/astro-group-bristol/Gradus.jl/blob/986ca5b98f4e4d33258968a79ebdcbc130579561/src/GradusBase/metric-params.jl#L15-L22">source</a></section><section><div><pre><code class="language-julia hljs">metric_components(
    m::AbstractAutoDiffStaticAxisSymmetricParams{T},
    rθ
) -&gt; Any
</code></pre><p>Interface for <a href="#Gradus.AbstractAutoDiffStaticAxisSymmetricParams"><code>AbstractAutoDiffStaticAxisSymmetricParams</code></a>. Should return a vector or tuple with the elements</p><p class="math-container">\[\left(
    g_{tt}, g_{rr}, g_{\theta \theta}, g_{\phi \phi}, g_{t\phi}
\right).\]</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/astro-group-bristol/Gradus.jl/blob/986ca5b98f4e4d33258968a79ebdcbc130579561/src/tracing/method-implementations/auto-diff.jl#L33-L43">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="Gradus.AbstractAutoDiffStaticAxisSymmetricParams" href="#Gradus.AbstractAutoDiffStaticAxisSymmetricParams"><code>Gradus.AbstractAutoDiffStaticAxisSymmetricParams</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">AbstractAutoDiffStaticAxisSymmetricParams{T} &lt;: AbstractAutoDiffMetricParams{T}</code></pre><p>Specialisation for static, axis-symmetric metrics. Here, the metric is of the form</p><p class="math-container">\[    g_{\mu\nu} =
    \left( \begin{matrix}
        g_{tt}     &amp; 0      &amp; 0                  &amp; g_{t\phi}     \\
        0          &amp; g_{rr} &amp; 0                  &amp; 0              \\
        0          &amp; 0      &amp; g_{\theta\theta} &amp; 0              \\
        g_{t\phi} &amp; 0      &amp; 0                  &amp; g_{\phi\phi}
    \end{matrix} \right),\]</p><p>where the only non-zero off axis elements are <span>$g_{t\phi}$</span>.</p><p>Required implementations:</p><ul><li><a href="../../api-documentation/GradusBase/#Gradus.GradusBase.inner_radius-Union{Tuple{AbstractMetricParams{T}}, Tuple{T}} where T"><code>inner_radius</code></a></li><li><a href="#Gradus.GradusBase.metric_components"><code>metric_components</code></a></li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/astro-group-bristol/Gradus.jl/blob/986ca5b98f4e4d33258968a79ebdcbc130579561/src/tracing/method-implementations/auto-diff.jl#L11-L29">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../overview/geodesic-integration/">« Geodesic integration</a><a class="docs-footer-nextpage" href="../special-radii/">Special radii »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Saturday 17 September 2022 05:40">Saturday 17 September 2022</span>. Using Julia version 1.8.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
